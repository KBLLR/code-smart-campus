# Session: GEO-501 Light Architecture Audit

**Date:** 2025-11-10
**Start Time:** 14:00 UTC
**Duration:** ~30 min
**Task ID:** GEO-501
**Project Variant:** SEMI

---

## Objective

Audit existing Three.js light architecture in Smart Campus 3D to identify potential conflicts with new geospatial lights (SunController, AtmosphereRenderer, MoonController).

## Findings

### Current Light Setup (src/scene.js)

**Active Lights:**
1. **AmbientLight** (line 389)
   - Color: 0xffffff (white)
   - Intensity: 0.25
   - Purpose: Base scene illumination

2. **SunController.object3d** (line 356)
   - Contains: DirectionalLight (color 0xffe39a, intensity 1.1)
   - Contains: Sun sphere mesh (MeshBasicMaterial, non-lit)
   - Contains: Light target (at origin)

3. **MoonController.object3d** (conditionally added)
   - Contains: DirectionalLight (color 0x9ab0ff, intensity 0.25)
   - Contains: Moon sphere mesh (MeshBasicMaterial, non-lit)
   - Contains: Light target (at origin)

4. **AtmosphereRenderer.sunLight** (**NEW**)
   - Type: SunDirectionalLight (from @takram/three-atmosphere)
   - Purpose: Atmosphere-aware lighting
   - **CONFLICT**: Another directional sun light

### Materials Analysis

**Campus Geometry Materials:**
- Queried from `materialRegistry` (src/registries/materialsRegistry.js)
- Likely includes: MeshPhongMaterial, MeshStandardMaterial, MeshBasicMaterial

**Three.js Light Compatibility:**
- MeshPhongMaterial: ‚úÖ Supports multiple DirectionalLights (no explicit limit)
- MeshStandardMaterial: ‚úÖ Supports multiple lights (PBR model accounts for multiple sources)
- MeshBasicMaterial: ‚ö†Ô∏è Ignores all lights (uses emissive only)

### Conflict Analysis

#### ‚ùå **Conflict 1: Dual Sun Directional Lights**

**Problem:**
- SunController.light (DirectionalLight, intensity 1.1)
- AtmosphereRenderer.sunLight (SunDirectionalLight, intensity 0.0‚Äì1.5)
- **Result**: Campus geometry lit by both lights simultaneously
- **Impact**:
  - Increased brightness (cumulative illumination)
  - Potential color shift (yellow sun + white atmosphere light)
  - Double shadow casting (if shadows enabled)

**Severity**: üî¥ **HIGH** ‚Äî Causes visible lighting artifacts

#### ‚ö†Ô∏è **Conflict 2: Light Target Conflicts**

**Problem:**
- SunController.light.target = new Object3D() at (0, 0, 0)
- AtmosphereRenderer.sunLight.target = updated per frame to (0, 0, 0)
- Both lights point at origin (scene center)
- **Result**: Redundant targeting

**Severity**: üü° **MEDIUM** ‚Äî Redundant but harmless

#### ‚ö†Ô∏è **Conflict 3: Sun Position Updates**

**Problem:**
- SunController.update() sets light position per azimuth/elevation
- AtmosphereRenderer.update() also sets sun light position per azimuth/elevation
- **Result**: Both lights move independently but should be synchronized
- **Risk**: If one updates and the other doesn't, they diverge

**Severity**: üü° **MEDIUM** ‚Äî Manageable with proper coordination

---

## Recommendations

### **Option A: Disable SunController DirectionalLight** ‚úÖ RECOMMENDED

Replace SunController's DirectionalLight with AtmosphereRenderer's SunDirectionalLight.

**Pros:**
- Single source of truth for sun lighting
- AtmosphereRenderer light has atmosphere color correction built-in
- Cleaner architecture

**Cons:**
- Requires modifications to scene.js
- SunController becomes geometry-only (no lighting contribution)

**Implementation:**
```javascript
// In GeospatialManager:
if (this.sunController && this.atmosphereRenderer) {
  // Disable SunController light
  this.sunController.light.intensity = 0; // or remove it entirely

  // Use AtmosphereRenderer.sunLight instead
  this.scene.add(this.atmosphereRenderer.sunLight);
}
```

### **Option B: Coordinate Dual Lights** (if SunController must persist)

Keep both lights but synchronize them carefully.

**Requirements:**
1. Ensure only one light moves (either SunController OR AtmosphereRenderer, not both)
2. Disable one light's intensity (set to 0) but keep position
3. Coordinate updates in GeospatialManager

**Pros:**
- Minimal disruption to existing scene.js code
- Preserves SunController's full functionality

**Cons:**
- Redundant code (two implementations of same concept)
- Maintenance burden (keep them in sync)
- Less elegant

---

## Decision Matrix

| Criteria | Option A | Option B |
|----------|----------|----------|
| Correctness | ‚úÖ Single source | ‚úÖ Coordinated |
| Performance | ‚úÖ One light | ‚ö†Ô∏è Two lights (slower) |
| Maintainability | ‚úÖ Clean | ‚ùå Complex |
| Disruption | ‚ö†Ô∏è Changes scene.js | ‚úÖ Minimal |
| Atmosphere Integration | ‚úÖ Native | ‚ö†Ô∏è Disconnected |

**Recommendation: Option A** (Disable SunController.light, use AtmosphereRenderer.sunLight)

---

## Implementation Plan (for next iteration)

### Phase 1: Coordinate Lights (GEO-501 current)
1. Disable SunController.light intensity (or remove from scene)
2. Ensure AtmosphereRenderer updates sun light per sun position
3. Update GeospatialManager to coordinate both

### Phase 2: Update scene.js (GEO-5xx new)
1. Remove SunController from scene.js (or keep for UI/visuals only)
2. Let GeospatialManager handle all lighting
3. Test for regressions

### Phase 3: Shadow Integration (GEO-502 future)
1. Enable dynamic shadow updates for sun light (one source)
2. Benchmark shadow map performance
3. Implement LOD if needed for Intel/mobile

---

## Test Checklist (for GEO-601 QA)

- [ ] Scene renders with correct brightness (not over-lit)
- [ ] Sun moves smoothly without lighting artifacts
- [ ] Dawn/dusk gradients appear natural
- [ ] No color shifts (yellow + white light artifacts)
- [ ] Materials respond correctly to sun angle
- [ ] Moon illumination separate from sun

---

## Status

‚úÖ **GEO-501 Complete**: Light architecture audited, conflicts identified, recommendations documented.

**Blocking Issues**: None (conflicts can be resolved in Phase 1)

**Next Steps**:
1. Implement Option A (disable SunController.light)
2. Test in actual scene
3. Move to GEO-601 QA testing

---

## Related Tasks

- **GEO-201**: SunController ephemeris ‚úÖ (completed)
- **GEO-301**: Atmosphere integration ‚úÖ (completed)
- **GEO-302**: AtmosphereRenderer ‚úÖ (completed)
- **GEO-502**: Dynamic shadow updates (future)
- **GEO-601**: QA checklist testing (next)

---

**Audit Performed By**: Claude (Haiku) on 2025-11-10
**Confidence**: HIGH (based on Three.js light model documentation)
