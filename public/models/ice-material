# Blender Python Script: Turn All Meshes into Frozen Ice (Updated for Blender 4.0+)
# -----------------------------------------------------------------------------
# Creates a basic ice-like material (for Cycles primarily)
# and applies it to all mesh objects in the scene, replacing
# their existing materials.

import bpy

print("\n--- Creating and Applying Frozen Ice Material (Blender 4.x Compatible) ---")

# --- Define Material Properties ---
material_name = "FrozenIceMaterial_v4" # Slightly different name to avoid conflicts if needed
base_color = (1.0, 1.0, 1.0, 1.0) # RGBA - White/Clear
metallic = 0.0
roughness = 0.15 # Slightly rough, affects both reflection and transmission in Blender 4+
# NOTE: Transmission *amount* is now controlled by "Transmission Weight"
transmission_weight = 1.0 # Fully transparent (0.0 = opaque, 1.0 = fully transmissive)
ior = 1.31 # Index of Refraction for Ice
# NOTE: Transmission *roughness* in Blender 4+ is primarily controlled
# by the main "Roughness" input above. There isn't a separate dedicated
# "Transmission Roughness" input like in older versions.
# You can use "Subsurface Roughness" for some effects, but the main
# Roughness is usually sufficient for basic ice/glass.

# --- Create or Get the Ice Material ---
ice_material = bpy.data.materials.get(material_name)

if ice_material is None:
    # Material doesn't exist, create it
    ice_material = bpy.data.materials.new(name=material_name)
    ice_material.use_nodes = True # Enable node-based material setup
    print(f"Created new material: '{material_name}'")

    # Get the node tree and the default Principled BSDF shader
    nodes = ice_material.node_tree.nodes
    principled_bsdf = nodes.get("Principled BSDF")

    if principled_bsdf:
        # Set the parameters on the Principled BSDF node
        principled_bsdf.inputs["Base Color"].default_value = base_color
        principled_bsdf.inputs["Metallic"].default_value = metallic
        principled_bsdf.inputs["Roughness"].default_value = roughness # Controls reflection AND transmission roughness

        # --- THIS IS THE CORRECTED LINE FOR BLENDER 4.x ---
        principled_bsdf.inputs["Transmission Weight"].default_value = transmission_weight
        # --- End of Correction ---

        principled_bsdf.inputs["IOR"].default_value = ior
        # Optional: Set Subsurface parameters if needed for more complex ice
        # principled_bsdf.inputs["Subsurface Weight"].default_value = 0.0 # Default
        # principled_bsdf.inputs["Subsurface Roughness"].default_value = roughness # Often linked to main roughness

        print("Configured Principled BSDF for ice properties (Blender 4.x).")
    else:
        print(f"Error: Could not find the 'Principled BSDF' node in the new material.")
        print("Cannot configure material. Aborting.")
        # Clean up the partially created material if setup failed
        bpy.data.materials.remove(ice_material)
        ice_material = None # Ensure we don't proceed
else:
    print(f"Found existing material: '{material_name}'. It will be reused.")
    # Consider adding code here to UPDATE the existing material if needed

# --- Apply the Material to All Meshes ---
if ice_material:
    applied_count = 0
    # Get all mesh objects in the current scene
    mesh_objects = [obj for obj in bpy.context.scene.objects if obj.type == 'MESH']

    if not mesh_objects:
        print("No mesh objects found in the scene to apply the material to.")
    else:
        print(f"Found {len(mesh_objects)} mesh object(s). Applying material...")
        for obj in mesh_objects:
            if obj.data: # Check if the object has mesh data
                obj.data.materials.clear()
                obj.data.materials.append(ice_material)
                applied_count += 1

        print(f"\nSuccessfully applied material '{material_name}' to {applied_count} mesh object(s).")
else:
    print("Failed to create or find the ice material. No changes were made to object materials.")

print("--- Script Finished ---")

# Optional: Set Render Engine to Cycles
# bpy.context.scene.render.engine = 'CYCLES'
# print("Switched render engine to Cycles for best results.")